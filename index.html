<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pendataan UTTP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4">Pendataan UTTP Kota Tasikmalaya</h2>

  <!-- Form Input -->
  <form id="uttpForm" class="mb-4">
    <input type="hidden" id="rowNumber" />
    <div class="row g-3">
      <div class="col-md-4"><input required class="form-control" placeholder="Jenis UTTP" id="jenis" /></div>
      <div class="col-md-4"><input required class="form-control" placeholder="Merk" id="merk" /></div>
      <div class="col-md-4"><input required class="form-control" placeholder="Model/Tipe" id="model" /></div>
      <div class="col-md-4"><input required class="form-control" placeholder="Nomor Seri" id="noseri" /></div>
      <div class="col-md-4"><input required type="date" class="form-control" placeholder="Tanggal Tera" id="tanggal" /></div>
      <div class="col-md-4"><input required class="form-control" placeholder="Nama Pemilik" id="pemilik" /></div>
      <div class="col-md-8"><input required class="form-control" placeholder="Lokasi (alamat/koordinat)" id="lokasi" /></div>
      <div class="col-md-4 d-grid"><button class="btn btn-primary" type="submit" id="submitBtn">Simpan Data</button></div>
    </div>
  </form>

  <!-- Preview Maps -->
  <div class="mb-4">
    <h6>Preview Lokasi:</h6>
    <iframe id="mapPreview" width="100%" height="300" class="border rounded" loading="lazy" allowfullscreen></iframe>
  </div>

  <div id="status" class="alert d-none"></div>

  <!-- Tombol Export -->
  <div class="mb-3">
    <button class="btn btn-success" onclick="exportToExcel()">Export ke Excel</button>
  </div>

  <!-- Tabel Data -->
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Jenis</th><th>Merk</th><th>Model</th><th>No Seri</th><th>Tanggal</th><th>Pemilik</th><th>Lokasi</th><th>Aksi</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<script>
const form = document.getElementById("uttpForm");
const dataBody = document.getElementById("dataBody");
const statusEl = document.getElementById("status");
const submitBtn = document.getElementById("submitBtn");
const scriptURL = "https://script.google.com/macros/s/AKfycbzIEeiHKy9PWbvZn4E82zff9AOKdiKSjW4whGA7dSrU6aiEwwOychWSnvnPn_1ojQxs/exec"; // Ganti dengan URL Web App kamu

// Load Data dari Google Sheet
async function loadData() {
  const res = await fetch(scriptURL);
  const text = await res.text();
  console.log("Response:", text); // Tambahkan ini
  try {
    const json = JSON.parse(text);
    const data = json.values;
    dataBody.innerHTML = "";
    data.slice(1).forEach((row, i) => {
      const lokasiLink = <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(row[6])}" target="_blank">${row[6]}</a>;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td>
        <td>${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td>
        <td>${lokasiLink}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="editData(${i+2}, ${JSON.stringify(row).replace(/"/g, '&quot;')})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteData(${i+2})">Hapus</button>
        </td>`;
      dataBody.appendChild(tr);
    });
  } catch (err) {
    console.error("Gagal parse JSON:", err);
  }
}

// Submit Form
form.addEventListener("submit", async e => {
  e.preventDefault();
  try {
    const data = {
      action: form.rowNumber.value ? "update" : "add",
      rowNumber: form.rowNumber.value,
      jenis: form.jenis.value,
      merk: form.merk.value,
      model: form.model.value,
      noseri: form.noseri.value,
      tanggal: form.tanggal.value,
      pemilik: form.pemilik.value,
      lokasi: form.lokasi.value
    };
    console.log("Data akan dikirim:", data);
    alert("Mengirim data ke server...");
    const res = await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" }
    });
    if (!res.ok) throw new Error(HTTP error! status: ${res.status});
    const responseText = await res.text();
    alert("Respon server: " + responseText);
    statusEl.textContent = responseText;
    statusEl.className = "alert alert-success my-2";
    form.reset();
    form.rowNumber.value = "";
    submitBtn.textContent = "Simpan Data";
    document.getElementById("mapPreview").src = "";
    loadData();
  } catch (error) {
    console.error("Error saat submit:", error);
    alert("Error: " + error.message);
    statusEl.textContent = "Error: " + error.message;
    statusEl.className = "alert alert-danger my-2";
  }
});

// Edit
function editData(rowNumber, rowData) {
  form.rowNumber.value = rowNumber;
  form.jenis.value = rowData[0];
  form.merk.value = rowData[1];
  form.model.value = rowData[2];
  form.noseri.value = rowData[3];
  form.tanggal.value = rowData[4];
  form.pemilik.value = rowData[5];
  form.lokasi.value = rowData[6];
  form.lokasi.dispatchEvent(new Event("input")); // Update preview peta
  submitBtn.textContent = "Update Data";
  statusEl.classList.add("d-none");
}

// Hapus
async function deleteData(rowNumber) {
  if (!confirm("Yakin ingin menghapus data ini?")) return;
  const res = await fetch(scriptURL, {
    method: "POST",
    body: JSON.stringify({ action: "delete", rowNumber }),
    headers: { "Content-Type": "application/json" }
  });
  alert(await res.text());
  loadData();
}

// Export ke Excel
function exportToExcel() {
  const table = document.querySelector("table");
  const wb = XLSX.utils.table_to_book(table, { sheet: "UTTP" });
  XLSX.writeFile(wb, "pendataan_uttp.xlsx");
}
</script>

</body>
</html>
